@{
    ViewData["Title"] = "Appointments";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Appointments</h2>
                    <p class="text-muted">Manage your appointments</p>
                </div>
                <div>
                    <a href="@Url.Action("Schedule")" class="btn btn-secondary">
                        <i class="fas fa-calendar-week"></i> Schedule
                    </a>
                    <a href="@Url.Action("DailyView")" class="btn btn-info">
                        <i class="fas fa-calendar-day"></i> Daily View
                    </a>
                </div>
            </div>

            <!-- Appointment Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="dateFilter" class="form-label">Date</label>
                            <input type="date" class="form-control" id="dateFilter" />
                        </div>
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">Status</label>
                            <select class="form-control" id="statusFilter">
                                <option value="">All Statuses</option>
                                <option value="Scheduled">Scheduled</option>
                                <option value="Confirmed">Confirmed</option>
                                <option value="InProgress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                                <option value="NoShow">No Show</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="patientFilter" class="form-label">Patient Name</label>
                            <input type="text" class="form-control" id="patientFilter" placeholder="Search patient..." />
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary me-2" onclick="filterAppointments()">
                                <i class="fas fa-search"></i> Filter
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointments Summary -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="todayCount">0</h4>
                                    <p class="mb-0">Today</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-calendar-day fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="upcomingCount">0</h4>
                                    <p class="mb-0">Upcoming</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clock fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="completedCount">0</h4>
                                    <p class="mb-0">Completed</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="cancelledCount">0</h4>
                                    <p class="mb-0">Cancelled</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-times-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointments Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Appointments List</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="appointmentsTable">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Patient</th>
                                    <th>Contact</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentsTableBody">
                                <!-- Appointments will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="noAppointments" class="text-center text-muted py-4" style="display: none;">
                        <i class="fas fa-calendar-times fa-3x mb-3"></i>
                        <h5>No Appointments Found</h5>
                        <p>No appointments match your current filters.</p>
                    </div>
                    
                    <div id="loadingAppointments" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading appointments...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Details Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Appointment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="appointmentDetails">
                <!-- Appointment details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updateStatusBtn">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Appointment Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateStatusForm">
                <div class="modal-body">
                    <input type="hidden" id="appointmentId" name="appointmentId" />
                    
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">New Status</label>
                        <select class="form-control" id="newStatus" name="status" required>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="InProgress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="NoShow">No Show</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="statusNotes" name="notes" rows="3" placeholder="Add any notes about this status change..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let appointments = [];
    let filteredAppointments = [];
    
    // Load appointments on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAppointments();
    });
    
    function loadAppointments() {
        // Show loading indicator
        document.getElementById('loadingAppointments').style.display = 'block';
        document.getElementById('noAppointments').style.display = 'none';
        
        // Simulate API call - replace with actual endpoint
        setTimeout(() => {
            // Mock data - replace with actual API call
            appointments = generateMockAppointments();
            filteredAppointments = [...appointments];
            
            displayAppointments();
            updateSummaryCards();
            
            document.getElementById('loadingAppointments').style.display = 'none';
        }, 1000);
    }
    
    function generateMockAppointments() {
        // Mock appointment data - replace with actual API call
        const mockAppointments = [
            {
                id: 1,
                date: new Date(),
                time: '09:00',
                patientName: 'John Doe',
                patientEmail: 'john@example.com',
                patientPhone: '+1234567890',
                reason: 'Regular checkup',
                status: 'Scheduled',
                notes: ''
            },
            {
                id: 2,
                date: new Date(Date.now() + 86400000), // Tomorrow
                time: '10:30',
                patientName: 'Jane Smith',
                patientEmail: 'jane@example.com',
                patientPhone: '+1234567891',
                reason: 'Follow-up consultation',
                status: 'Confirmed',
                notes: 'Patient requested morning appointment'
            },
            {
                id: 3,
                date: new Date(Date.now() - 86400000), // Yesterday
                time: '14:00',
                patientName: 'Bob Johnson',
                patientEmail: 'bob@example.com',
                patientPhone: '+1234567892',
                reason: 'Blood pressure check',
                status: 'Completed',
                notes: 'Patient responded well to treatment'
            }
        ];
        
        return mockAppointments;
    }
    
    function displayAppointments() {
        const tbody = document.getElementById('appointmentsTableBody');
        tbody.innerHTML = '';
        
        if (filteredAppointments.length === 0) {
            document.getElementById('noAppointments').style.display = 'block';
            return;
        }
        
        document.getElementById('noAppointments').style.display = 'none';
        
        filteredAppointments.forEach(appointment => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div>
                        <strong>${appointment.date.toLocaleDateString()}</strong><br>
                        <small class="text-muted">${appointment.time}</small>
                    </div>
                </td>
                <td>
                    <div>
                        <strong>${appointment.patientName}</strong>
                    </div>
                </td>
                <td>
                    <div>
                        <small>${appointment.patientEmail}</small><br>
                        <small class="text-muted">${appointment.patientPhone}</small>
                    </div>
                </td>
                <td>${appointment.reason}</td>
                <td>
                    <span class="badge bg-${getStatusBadgeClass(appointment.status)}">
                        ${appointment.status}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewAppointment(${appointment.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="updateAppointmentStatus(${appointment.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function updateSummaryCards() {
        const today = new Date().toDateString();
        const todayAppointments = appointments.filter(a => a.date.toDateString() === today);
        const upcomingAppointments = appointments.filter(a => a.date > new Date() && a.status !== 'Cancelled');
        const completedAppointments = appointments.filter(a => a.status === 'Completed');
        const cancelledAppointments = appointments.filter(a => a.status === 'Cancelled' || a.status === 'NoShow');
        
        document.getElementById('todayCount').textContent = todayAppointments.length;
        document.getElementById('upcomingCount').textContent = upcomingAppointments.length;
        document.getElementById('completedCount').textContent = completedAppointments.length;
        document.getElementById('cancelledCount').textContent = cancelledAppointments.length;
    }
    
    function getStatusBadgeClass(status) {
        switch (status) {
            case 'Scheduled': return 'primary';
            case 'Confirmed': return 'info';
            case 'InProgress': return 'warning';
            case 'Completed': return 'success';
            case 'Cancelled': return 'danger';
            case 'NoShow': return 'dark';
            default: return 'secondary';
        }
    }
    
    function filterAppointments() {
        const dateFilter = document.getElementById('dateFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const patientFilter = document.getElementById('patientFilter').value.toLowerCase();
        
        filteredAppointments = appointments.filter(appointment => {
            const matchesDate = !dateFilter || appointment.date.toISOString().split('T')[0] === dateFilter;
            const matchesStatus = !statusFilter || appointment.status === statusFilter;
            const matchesPatient = !patientFilter || appointment.patientName.toLowerCase().includes(patientFilter);
            
            return matchesDate && matchesStatus && matchesPatient;
        });
        
        displayAppointments();
    }
    
    function clearFilters() {
        document.getElementById('dateFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('patientFilter').value = '';
        
        filteredAppointments = [...appointments];
        displayAppointments();
    }
    
    function viewAppointment(appointmentId) {
        const appointment = appointments.find(a => a.id === appointmentId);
        if (!appointment) return;
        
        const detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Patient Information</h6>
                    <p><strong>Name:</strong> ${appointment.patientName}</p>
                    <p><strong>Email:</strong> ${appointment.patientEmail}</p>
                    <p><strong>Phone:</strong> ${appointment.patientPhone}</p>
                </div>
                <div class="col-md-6">
                    <h6>Appointment Details</h6>
                    <p><strong>Date:</strong> ${appointment.date.toLocaleDateString()}</p>
                    <p><strong>Time:</strong> ${appointment.time}</p>
                    <p><strong>Status:</strong> <span class="badge bg-${getStatusBadgeClass(appointment.status)}">${appointment.status}</span></p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Reason for Visit</h6>
                    <p>${appointment.reason}</p>
                </div>
            </div>
            ${appointment.notes ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Notes</h6>
                    <p>${appointment.notes}</p>
                </div>
            </div>
            ` : ''}
        `;
        
        document.getElementById('appointmentDetails').innerHTML = detailsHtml;
        new bootstrap.Modal(document.getElementById('appointmentModal')).show();
    }
    
    function updateAppointmentStatus(appointmentId) {
        const appointment = appointments.find(a => a.id === appointmentId);
        if (!appointment) return;
        
        document.getElementById('appointmentId').value = appointmentId;
        document.getElementById('newStatus').value = appointment.status;
        document.getElementById('statusNotes').value = '';
        
        new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
    }
    
    // Handle status update form submission
    document.getElementById('updateStatusForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const appointmentId = parseInt(document.getElementById('appointmentId').value);
        const newStatus = document.getElementById('newStatus').value;
        const notes = document.getElementById('statusNotes').value;
        
        // Find and update the appointment
        const appointmentIndex = appointments.findIndex(a => a.id === appointmentId);
        if (appointmentIndex !== -1) {
            appointments[appointmentIndex].status = newStatus;
            if (notes) {
                appointments[appointmentIndex].notes = notes;
            }
            
            // Refresh the display
            filteredAppointments = [...appointments];
            displayAppointments();
            updateSummaryCards();
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
            
            // Show success message
            alert('Appointment status updated successfully!');
        }
    });
</script>
}