@model BookAppointmentViewModel
@{
    ViewData["Title"] = "Book Appointment";
    Layout = "~/Views/Shared/_PatientLayout.cshtml";
}

<div class="dashboard-content">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-4">
                    <div class="text-center">
                        <i class="fas fa-calendar-plus fa-3x text-primary mb-3"></i>
                        <h2 class="card-title mb-2">Book New Appointment</h2>
                        <p class="text-muted">Schedule your visit with one of our healthcare professionals</p>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <form asp-action="BookAppointment" method="post" class="needs-validation" novalidate>
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <!-- Doctor Selection -->
                        <div class="mb-4">
                            <label asp-for="DoctorId" class="form-label fw-semibold">
                                <i class="fas fa-user-md me-2 text-primary"></i>Select Doctor
                            </label>
                            <select asp-for="DoctorId" class="form-select form-select-lg" required>
                                <option value="">Choose a doctor...</option>
                                @foreach (var doctor in Model.AvailableDoctors)
                                {
                                    <option value="@doctor.Id" data-specialization="@doctor.Specialization">
                                        Dr. @doctor.FirstName @doctor.LastName
                                        @if (!string.IsNullOrEmpty(doctor.Specialization))
                                        {
                                            <text> - @doctor.Specialization</text>
                                        }
                                    </option>
                                }
                            </select>
                            <span asp-validation-for="DoctorId" class="text-danger"></span>
                        </div>

                        <!-- Date and Time Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="AppointmentDate" class="form-label fw-semibold">
                                    <i class="fas fa-calendar me-2 text-primary"></i>Appointment Date
                                </label>
                                <input asp-for="AppointmentDate" type="date" class="form-control form-control-lg" 
                                       min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" 
                                       max="@DateTime.Today.AddMonths(3).ToString("yyyy-MM-dd")" required />
                                <span asp-validation-for="AppointmentDate" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>Appointments can be scheduled up to 3 months in advance
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label asp-for="AppointmentTime" class="form-label fw-semibold">
                                    <i class="fas fa-clock me-2 text-primary"></i>Preferred Time
                                </label>
                                <select asp-for="AppointmentTime" class="form-select form-select-lg" required>
                                    <option value="">Select time...</option>
                                    <optgroup label="Morning">
                                        <option value="09:00:00">9:00 AM</option>
                                        <option value="09:30:00">9:30 AM</option>
                                        <option value="10:00:00">10:00 AM</option>
                                        <option value="10:30:00">10:30 AM</option>
                                        <option value="11:00:00">11:00 AM</option>
                                        <option value="11:30:00">11:30 AM</option>
                                    </optgroup>
                                    <optgroup label="Afternoon">
                                        <option value="14:00:00">2:00 PM</option>
                                        <option value="14:30:00">2:30 PM</option>
                                        <option value="15:00:00">3:00 PM</option>
                                        <option value="15:30:00">3:30 PM</option>
                                        <option value="16:00:00">4:00 PM</option>
                                        <option value="16:30:00">4:30 PM</option>
                                    </optgroup>
                                    <optgroup label="Evening">
                                        <option value="17:00:00">5:00 PM</option>
                                        <option value="17:30:00">5:30 PM</option>
                                        <option value="18:00:00">6:00 PM</option>
                                    </optgroup>
                                </select>
                                <span asp-validation-for="AppointmentTime" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Reason for Visit -->
                        <div class="mb-4">
                            <label asp-for="Reason" class="form-label fw-semibold">
                                <i class="fas fa-notes-medical me-2 text-primary"></i>Reason for Visit
                            </label>
                            <textarea asp-for="Reason" class="form-control" rows="4" 
                                      placeholder="Please describe the reason for your visit, symptoms, or concerns..." 
                                      maxlength="500" required></textarea>
                            <span asp-validation-for="Reason" class="text-danger"></span>
                            <div class="form-text">
                                <span id="reasonCounter">0</span>/500 characters
                            </div>
                        </div>

                        <!-- Important Information -->
                        <div class="alert alert-info border-0">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>Important Information
                            </h6>
                            <ul class="mb-0 ps-3">
                                <li>Please arrive 15 minutes before your scheduled appointment</li>
                                <li>Bring a valid ID and insurance card</li>
                                <li>You will receive a confirmation email once your appointment is approved</li>
                                <li>Cancellations must be made at least 24 hours in advance</li>
                            </ul>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-3 justify-content-end">
                            <a asp-action="Dashboard" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-calendar-check me-2"></i>Book Appointment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Character counter for reason textarea
            $('#Reason').on('input', function() {
                var length = $(this).val().length;
                $('#reasonCounter').text(length);
                
                if (length > 450) {
                    $('#reasonCounter').addClass('text-warning');
                } else {
                    $('#reasonCounter').removeClass('text-warning');
                }
            });

            // Form validation
            $('.needs-validation').on('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                $(this).addClass('was-validated');
            });

            // Doctor selection enhancement
            $('#DoctorId').on('change', function() {
                var selectedOption = $(this).find('option:selected');
                var specialization = selectedOption.data('specialization');
                
                if (specialization) {
                    // You could add additional logic here based on specialization
                    console.log('Selected doctor specialization:', specialization);
                }
            });

            // Date validation
            $('#AppointmentDate').on('change', function() {
                var selectedDate = new Date($(this).val());
                var today = new Date();
                var dayOfWeek = selectedDate.getDay();
                
                // Check if it's a weekend (0 = Sunday, 6 = Saturday)
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    alert('Please select a weekday for your appointment. Weekend appointments are not available.');
                    $(this).val('');
                }
            });

            // Initialize character counter
            $('#Reason').trigger('input');
        });
    </script>
}

<style>
.card {
    border-radius: 15px;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.form-label {
    color: #495057;
    margin-bottom: 8px;
}

.btn-lg {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
}

.alert-info {
    background-color: #e7f3ff;
    border-left: 4px solid #007bff;
}

.was-validated .form-control:invalid,
.was-validated .form-select:invalid {
    border-color: #dc3545;
}

.was-validated .form-control:valid,
.was-validated .form-select:valid {
    border-color: #28a745;
}

#reasonCounter.text-warning {
    font-weight: bold;
}
</style>